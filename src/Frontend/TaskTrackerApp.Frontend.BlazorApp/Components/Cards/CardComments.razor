@using TaskTrackerApp.Frontend.Domain.DTOs.CardComments
@using TaskTrackerApp.Frontend.Services.Abstraction.Interfaces.Services
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using System.Security.Claims

<div class="mt-6">
    <div class="d-flex justify-space-between align-center mb-4">
        <div class="d-flex align-center gap-2">
            <MudIcon Icon=@Icons.Material.Filled.Forum Class="mud-text-secondary" />
            <MudText Typo=Typo.h6>Comments</MudText>
        </div>
    </div>

    @if (!IsReadOnly)
    {
        <div class="d-flex gap-3 mb-6">
            <MudAvatar Color=Color.Primary Size=Size.Medium>
                @if (!string.IsNullOrEmpty(_currentUserAvatarUrl))
                {
                    <MudImage Src="@_currentUserAvatarUrl" Alt="Me" />
                }
                else
                {
                    @(_currentUserInitials)
                }
            </MudAvatar>

            <div class="flex-grow-1">
                <MudTextField @bind-Value="_newCommentText"
                              Placeholder="Write a comment... (Paste images here)"
                              Variant=Variant.Outlined
                              Lines=@(_isFocused || _selectedFiles.Any() ? 3 : 1)
                              OnAdornmentClick=@(() => _isFocused = true)
                              OnBlur=OnInputBlur
                              Immediate=true
                              Class="mb-2 bg-white"
                              @onpaste=HandlePaste />

                @if (_selectedFiles.Any())
                {
                    <div class="d-flex flex-wrap gap-2 mb-2">
                        @foreach (var file in _selectedFiles)
                        {
                            <MudChip T="IBrowserFile" OnClose=@(() => RemoveFile(file)) Size=Size.Small Color=Color.Surface Variant=Variant.Outlined>
                                <MudIcon Icon=@GetFileIcon(file.ContentType) Size=Size.Small Class="mr-1" />
                                @file.Name
                            </MudChip>
                        }
                    </div>
                }

                <div class="d-flex justify-space-between align-center">
                    <div>
                        <InputFile id="fileInput" OnChange=HandleFileSelected multiple style="display:none" />
                        <MudButton HtmlTag="label" for="fileInput"
                                   Variant=Variant.Text
                                   StartIcon=@Icons.Material.Filled.AttachFile
                                   Color=Color.Default
                                   Size=Size.Small>
                            Attach
                        </MudButton>
                    </div>

                    <MudButton Variant=Variant.Filled
                               Color=Color.Primary
                               OnClick=AddComment
                               Disabled=@(string.IsNullOrWhiteSpace(_newCommentText) && !_selectedFiles.Any())>
                        Save
                    </MudButton>
                </div>
            </div>
        </div>
    }

    <div style="max-height: 400px; overflow-y: auto; overflow-x: hidden;" class="pr-2 custom-scrollbar">
        <MudStack Spacing="4">
            @foreach (var comment in _comments)
            {
                <div class="d-flex gap-3">
                    <MudAvatar Size=Size.Medium Color=Color.Secondary>
                        @if (!string.IsNullOrEmpty(comment.AuthorAvatarUrl))
                        {
                            <MudImage Src="@comment.AuthorAvatarUrl" />
                        }
                        else
                        {
                            @(GetInitials(comment.AuthorName))
                        }
                    </MudAvatar>

                    <div class="flex-grow-1">
                        <div class="d-flex align-center gap-2">
                            <MudText Typo=Typo.subtitle2 Class="fw-bold">@comment.AuthorName</MudText>
                            <MudText Typo=Typo.caption Class="mud-text-secondary">@comment.CreatedAt.ToString("MMM dd, yyyy h:mm tt")</MudText>
                            @if (comment.IsEdited)
                            {
                                <MudTooltip Text="@($"Edited at {comment.UpdatedAt?.ToString("t")}")">
                                    <MudText Typo=Typo.caption Class="mud-text-secondary" Style="cursor: help;">(edited)</MudText>
                                </MudTooltip>
                            }
                        </div>

                        @if (_editingCommentId == comment.Id)
                        {
                            <div class="mt-2">
                                <MudTextField @bind-Value="_editingText" Variant=Variant.Outlined Lines="3" AutoFocus=true @onpaste=HandlePaste Class ="mb-2 bg-white" />

                                @if (comment.Attachments.Any())
                                {
                                    <MudText Typo=Typo.caption Class="mb-1 d-block">Keep Attachments:</MudText>
                                    <div class="d-flex flex-wrap gap-2 mb-2">
                                        @foreach (var att in comment.Attachments)
                                        {
                                            var isKept = _keepAttachmentIds.Contains(att.Id);
                                            <MudChip T="string"
                                                     Variant=@(isKept ? Variant.Outlined : Variant.Text)
                                                     Color=@(isKept ? Color.Primary : Color.Error)
                                                     OnClick=@(() => ToggleKeepFile(att.Id))
                                                     Icon=@(isKept ? Icons.Material.Filled.Check : Icons.Material.Filled.Delete)>
                                                @att.FileName
                                            </MudChip>
                                        }
                                    </div>
                                }

                                <InputFile id="@($"editFile-{comment.Id}")" OnChange=HandleEditFilesSelected multiple style="display:none" />
                                <div class="d-flex gap-2 align-center mb-2">
                                    <MudButton HtmlTag="label" for="@($"editFile-{comment.Id}")" Variant=Variant.Text StartIcon=@Icons.Material.Filled.Add Size=Size.Small>Add Files</MudButton>
                                    @foreach (var newFile in _newEditFiles)
                                    {
                                        <MudChip T="IBrowserFile" Size=Size.Small>@newFile.Name</MudChip>
                                    }
                                </div>

                                <div class="d-flex gap-2">
                                    <MudButton Variant=Variant.Filled Color=Color.Primary Size=Size.Small OnClick=SaveEdit>Save</MudButton>
                                    <MudButton Variant=Variant.Text Color=Color.Default Size=Size.Small OnClick=CancelEdit>Cancel</MudButton>
                                </div>
                            </div>
                        }
                        else
                        {
                            <MudPaper Elevation="0" Class="pa-2 mt-1 rounded" Style="background-color: transparent;">
                                <MudText Typo=Typo.body2 Style="white-space: pre-wrap;">@comment.Text</MudText>

                                @if (comment.Attachments != null && comment.Attachments.Any())
                                {
                                    var images = comment.Attachments.Where(IsImage).ToList();
                                    var others = comment.Attachments.Where(a => !IsImage(a)).ToList();

                                    if (images.Any())
                                    {
                                        <div class="d-flex flex-column gap-2 mt-2">
                                            @foreach (var att in images)
                                            {
                                                <a href="@att.Url" target="_blank" style="display: block; max-width: 400px;">
                                                    <div class="rounded border d-flex justify-center align-center"
                                                         style="height: 300px; overflow: hidden; background-color: #f4f5f7;">
                                                        <MudImage Src="@att.Url" ObjectFit=ObjectFit.Contain Style="max-width: 100%; max-height: 100%;" />
                                                    </div>
                                                </a>
                                            }
                                        </div>
                                    }
                                    if (others.Any())
                                    {
                                        <div class="d-flex flex-wrap gap-2 mt-2">
                                            @foreach (var att in others)
                                            {
                                                <a href="@att.Url" target="_blank" style="text-decoration: none; max-width: 250px;">
                                                    <MudPaper Elevation="0" Outlined=true Class="d-flex align-center gap-2 pa-2 rounded cursor-pointer">
                                                        <MudIcon Icon=@GetFileIcon(att.ContentType) Size=Size.Large Color=Color.Secondary />
                                                        <div style="overflow: hidden;">
                                                            <MudText Typo=Typo.caption Class="text-truncate d-block fw-bold" Color="Color.Default">@att.FileName</MudText>
                                                            <MudText Typo=Typo.caption Class="mud-text-secondary">@FormatSize(att.Size)</MudText>
                                                        </div>
                                                    </MudPaper>
                                                </a>
                                            }
                                        </div>
                                    }
                                }
                            </MudPaper>

                            @if (!IsReadOnly && comment.CreatedById == _currentUserId)
                            {
                                <div class="d-flex gap-2 mt-1">
                                    <MudLink Typo=Typo.caption Color=Color.Default Underline=Underline.Hover OnClick=@(() => StartEdit(comment))>Edit</MudLink>
                                    <MudText Typo=Typo.caption Class="mud-text-secondary">•</MudText>
                                    <MudLink Typo=Typo.caption OnClick=@(() => DeleteComment(comment)) Color=Color.Error Underline=Underline.Hover>Delete</MudLink>
                                </div>
                            }
                        }
                    </div>
                </div>
            }
        </MudStack>
    </div>
</div>