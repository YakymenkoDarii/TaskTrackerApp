@using TaskTrackerApp.Frontend.Domain.DTOs.BoardMembers
@using TaskTrackerApp.Frontend.Domain.DTOs.Users
@using TaskTrackerApp.Frontend.Domain.Enums;

<MudDialog>
    <DialogContent>
        <div class="d-flex gap-3 align-center mb-4">
            <MudAutocomplete T="UserSummaryDto"
                             Label="Email address or name"
                             @bind-Value="SelectedUser"
                             SearchFunc="@SearchUsers"
                             ToStringFunc=@(u => u?.Email)
                             DebounceInterval="500"
                             AdornmentIcon="@Icons.Material.Filled.Search"
                             Placeholder="Type to search..."
                             Class="flex-grow-1"
                             Variant="Variant.Outlined"
                             Margin="Margin.Dense">

                <ItemTemplate Context="user">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Class="pa-1">
                        <MudAvatar Size="Size.Small" Color="Color.Primary" Class="mr-2">
                            @if (!string.IsNullOrEmpty(user.AvatarUrl))
                            {
                                <MudImage Src="@user.AvatarUrl" />
                            }
                            else
                            {
                                @(user.DisplayName?.FirstOrDefault() ?? '?')
                            }
                        </MudAvatar>

                        <MudStack Spacing="0">
                            <div class="d-flex align-baseline gap-1">
                                <MudText Typo="Typo.body1" Class="fw-bold">@user.DisplayName</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@($"@{user.Tag}")</MudText>
                            </div>

                            <MudText Typo="Typo.caption" Color="Color.Default">@user.Email</MudText>
                        </MudStack>
                    </MudStack>
                </ItemTemplate>

            </MudAutocomplete>

            <MudSelect T="BoardRole" @bind-Value="SelectedRole" Label="Role" Variant="Variant.Outlined" Margin="Margin.Dense" Style="width: 120px;">
                @foreach (BoardRole role in Enum.GetValues(typeof(BoardRole)))
                {
                    <MudSelectItem Value="@role">@GetRoleDisplayName(role)</MudSelectItem>
                }
            </MudSelect>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="SendInvite"
                       Disabled="@(SelectedUser == null)">
                Share
            </MudButton>
        </div>

        <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-3">

            <MudTabPanel Text="@($"Board members ({Members.Count})")">
                <MudList T="string" Clickable="false" Dense="true">
                    @foreach (var member in Members)
                    {
                        <MudListItem Avatar="@Icons.Material.Filled.Person">
                            <div class="d-flex justify-space-between align-center">
                                <div>
                                    <MudText Typo="Typo.body2" Class="fw-bold">@member.Name</MudText>
                                    <MudText Typo="Typo.caption">@member.Role</MudText>
                                </div>
                                @if (member.Role == "Admin")
                                {
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="Color.Primary">Admin</MudChip>
                                }
                            </div>
                        </MudListItem>
                        <MudDivider />
                    }
                </MudList>
            </MudTabPanel>

            <MudTabPanel Text="@($"Join requests ({PendingInvites.Count})")">
                @if (!PendingInvites.Any())
                {
                    <MudText Typo="Typo.body2" Align="Align.Center" Class="pa-4 text-muted">No pending invitations.</MudText>
                }
                else
                {
                    <MudList T="string" Clickable="false" Dense="true">
                        @foreach (var invite in PendingInvites)
                        {
                            <MudListItem Icon="@Icons.Material.Filled.Mail">
                                <div class="d-flex justify-space-between align-center w-100">
                                    <div>
                                        <MudText Typo="Typo.body2" Class="fw-bold">@invite.InviteeEmail</MudText>
                                        <MudText Typo="Typo.caption">Invited as @invite.Role • Pending</MudText>
                                    </div>
                                    <MudButton Variant="Variant.Outlined"
                                               Color="Color.Error"
                                               Size="Size.Small"
                                               OnClick="@(() => RevokeInvite(invite.Id))">
                                        Revoke
                                    </MudButton>
                                </div>
                            </MudListItem>
                            <MudDivider />
                        }
                    </MudList>
                }
            </MudTabPanel>
        </MudTabs>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Close</MudButton>
    </DialogActions>
</MudDialog>