@page "/board/{BoardId:int}"
@using TaskTrackerApp.Frontend.BlazorApp.Components
@using TaskTrackerApp.Frontend.Domain.DTOs.Boards
@using TaskTrackerApp.Frontend.Domain.DTOs.Columns
@using TaskTrackerApp.Frontend.Domain.DTOs.Cards
@using TaskTrackerApp.Frontend.Services.Abstraction.Interfaces.Services

<PageTitle>@(board?.Title ?? "Loading...")</PageTitle>

@if (isLoading)
{
    <MudContainer Class="d-flex justify-center align-center" Style="height: 80vh;">
        <MudProgressCircular Color=@Color.Info Indeterminate=@true />
    </MudContainer>
}
else if (board == null)
{
    <MudAlert Severity=@Severity.Error>Board not found.</MudAlert>
}
else
{
    <div class="board-container d-flex flex-column h-100">
        <div class="board-header px-4 py-3 d-flex align-center justify-space-between flex-shrink-0">
            <div>
                @if (IsAdmin)
                {
                    <EditableLabel @bind-Value=@board.Title
                                   OnCommit=@UpdateBoardDetails
                                   Typo=Typo.h5
                                   Style="color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.6); font-weight: bold;" />

                    <EditableLabel @bind-Value=@board.Description
                                   OnCommit=@UpdateBoardDetails
                                   Typo=Typo.body2
                                   Multiline=true
                                   Placeholder=@string.Empty
                                   Style="color: rgba(255, 255, 255, 0.9); text-shadow: 0px 0px 2px black;" />
                }
                else
                {
                    <MudText Typo="Typo.h5" Style="color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.6); font-weight: bold;">
                        @board.Title
                    </MudText>
                    <MudText Typo="Typo.body2" Style="color: rgba(255, 255, 255, 0.9); text-shadow: 0px 0px 2px black;">
                        @board.Description
                    </MudText>
                }
            </div>

            <div class="d-flex align-center">

                <div style="width: 250px;" class="mr-4">
                    <TaskSearch BoardId="@BoardId"
                                Placeholder="Search..."
                                OnTaskChanged="@LoadBoardDataAsync" />
                </div>

                <MudButton Variant="Variant.Filled"
                           StartIcon="@Icons.Material.Filled.PeopleAlt"
                           Color="Color.Secondary"
                           Class="mr-4 fw-bold"
                           OnClick="OpenShareDialog">
                    Members
                </MudButton>

                @if (CanEditContent)
                {
                    <MudPaper Elevation="0"
                              Class="d-flex align-center rounded pa-1 pl-3"
                              Style="background-color: rgba(255, 255, 255, 0.9); border: 1px solid var(--mud-palette-lines-inputs);">
                        <MudSwitch @bind-Value=@_isLayoutMode
                                   Color=@Color.Primary
                                   Label="Edit Layout"
                                   Class="ml-2"
                                   Style="color: var(--mud-palette-text-primary); font-weight: 500;" />
                    </MudPaper>
                }
            </div>
        </div>

        <div class="flex-grow-1 overflow-hidden" style="position:relative;">

            @if (_isLayoutMode && CanEditContent)
            {
                <MudDropContainer T=@ColumnDto
                                  @ref=@_columnDropContainer
                                  Items=@columns
                                  ItemsSelector=@((item,dropzone) => true)
                                  ItemDropped=@ColumnDropped
                                  Class="board-canvas d-flex h-100 overflow-auto px-4 pb-4">
                    <ChildContent>
                        <MudDropZone T=@ColumnDto
                                     Identifier="board-zone"
                                     Class="d-flex gap-4 h-100"
                                     AllowReorder="@CanEditContent" />

                        <div class="board-column px-4">
                            <MudButton Variant=@Variant.Filled
                                       Color=@Color.Success
                                       OnClick=@HandleAddColumn
                                       Class="py-2 fw-bold text-white">
                                Add another list
                            </MudButton>
                        </div>
                    </ChildContent>

                    <ItemRenderer>
                        <div class="board-column">
                            <MudPaper Class="column-paper pa-4 d-flex align-center justify-center cursor-move mud-theme-info"
                                      Elevation=4
                                      Style="height: 100px; opacity: 1.0; color: white;">
                                <MudIcon Icon=@Icons.Material.Filled.DragIndicator Class="mr-2" />
                                <MudText Typo=@Typo.h6>@context.Title</MudText>
                            </MudPaper>
                        </div>
                    </ItemRenderer>
                </MudDropContainer>
            }
            else
            {
                <MudDropContainer T=@CardDto
                                  @ref=@_cardDropContainer
                                  Items=@_allCards
                                  ItemsSelector=@((item, zone) => item.ColumnId.ToString() == zone)
                                  ItemDropped=@CardDropped
                                  Class="board-canvas d-flex h-100 overflow-auto px-4 pb-4 gap-4">
                    <ChildContent>
                        @foreach (var col in columns)
                        {
                            <div class="board-column">
                                <MudPaper Class="column-paper pa-2 d-flex flex-column"
                                          Elevation=2
                                          Style="max-height: 100%; background-color: #f0f2f5;">

                                    <div class="d-flex justify-space-between align-center mb-2 px-2">
                                        <div class="d-flex align-center flex-grow-1 gap-2" style="min-width: 0;">
                                            @if (CanEditContent)
                                            {
                                                <EditableLabel Value=@col.Title
                                                               ValueChanged="@((val) => col.Title = val)"
                                                               OnCommit="@(() => SaveColumn(col))"
                                                               Typo="Typo.subtitle1"
                                                               Style="font-weight: 700; color: #424242; white-space: nowrap;" />

                                                <EditableLabel Value=@col.Description
                                                               ValueChanged="@((val) => col.Description = val)"
                                                               OnCommit="@(() => SaveColumn(col))"
                                                               Typo="Typo.body2"
                                                               Placeholder=" "
                                                               Multiline="false"
                                                               Style="color: #757575; font-style: italic; min-width: 50px;" />
                                            }
                                            else
                                            {
                                                <MudText Typo="Typo.subtitle1" Style="font-weight: 700; color: #424242; white-space: nowrap;">
                                                    @col.Title
                                                </MudText>

                                                @if (!string.IsNullOrEmpty(col.Description))
                                                {
                                                    <MudText Typo="Typo.body2" Style="color: #757575; font-style: italic;">
                                                        @col.Description
                                                    </MudText>
                                                }
                                            }
                                        </div>

                                        @if (CanEditContent)
                                        {
                                            <MudMenu Icon=@Icons.Material.Filled.MoreHoriz Size=@Size.Small>
                                                <MudMenuItem Icon=@Icons.Material.Filled.Delete
                                                             IconColor=@Color.Error
                                                             OnClick=@(() => HandleDeleteColumn(col.Id))>
                                                    Delete List
                                                </MudMenuItem>
                                            </MudMenu>
                                        }
                                    </div>

                                    <MudDropZone T=@CardDto
                                                 Identifier=@col.Id.ToString()
                                                 Class="task-list mb-2 px-1 flex-grow-1 overflow-auto"
                                                 Style="min-height: 50px;"
                                                 AllowReorder="@CanEditContent" />

                                    @if (CanEditContent)
                                    {
                                        <MudButton StartIcon=@Icons.Material.Filled.Add
                                                   FullWidth=@true
                                                   Variant=@Variant.Text
                                                   Color=@Color.Dark
                                                   OnClick=@(() => HandleAddCard(col.Id))>
                                            Add a card
                                        </MudButton>
                                    }
                                </MudPaper>
                            </div>
                        }

                        @if (CanEditContent)
                        {
                            <div class="board-column px-4">
                                <MudButton Variant=@Variant.Filled
                                           Color=@Color.Success
                                           OnClick=@HandleAddColumn
                                           Class="py-2 fw-bold text-white">
                                    Add another list
                                </MudButton>
                            </div>
                        }
                    </ChildContent>

                    <ItemRenderer>
                        <MudCard Class=@($"mb-2 hover-effect {(CanEditContent ? "cursor-move" : "cursor-pointer")} {(IsOverdue(context) ? "border-solid border-2 mud-border-error" : "")}")
                                 Elevation=1
                                 onclick=@(() => HandleCardClick(context))>
                            <MudCardContent Class="pa-2">

                                <div class="d-flex align-center gap-2">
                                    <div @onclick:stopPropagation>
                                        <MudTooltip Text="@(context.IsCompleted ? "Mark incomplete" : $"Priority: {context.Priority}")">
                                            <MudIconButton Icon="@(context.IsCompleted? Icons.Material.Filled.CheckCircle : Icons.Material.Outlined.Circle)"
                                                           Color="@(context.IsCompleted ? Color.Success : GetPriorityColor(context.Priority))"
                                                           Size="Size.Small"
                                                           OnClick="@(() => HandleToggleComplete(context))" />
                                        </MudTooltip>
                                    </div>

                                    <MudText Typo=@Typo.body2
                                             Class="fw-bold flex-grow-1"
                                             Style=@(context.IsCompleted ? "text-decoration: line-through; color: gray;" : "")>
                                        @context.Title
                                    </MudText>
                                </div>

                                @if (!string.IsNullOrWhiteSpace(context.Description))
                                {
                                    <MudText Typo=@Typo.caption
                                             Class="d-block mud-text-secondary mt-1 text-truncate pl-10"
                                             Style=@(context.IsCompleted ? "text-decoration: line-through;" : "")>
                                        @context.Description
                                    </MudText>
                                }

                                @if (context.DueDate.HasValue)
                                {
                                    <div class="d-flex align-center gap-1 mt-2 pl-9">
                                        <MudIcon Icon=@Icons.Material.Filled.Schedule
                                                 Size=@Size.Small
                                                 Color=@(IsOverdue(context) ? Color.Error : Color.Default)
                                                 Style="font-size: 0.8rem;" />

                                        <MudText Typo=@Typo.caption
                                                 Color=@(IsOverdue(context) ? Color.Error : Color.Default)>
                                            @context.DueDate.Value.ToString("MMM dd")
                                        </MudText>
                                    </div>
                                }

                            </MudCardContent>
                        </MudCard>
                    </ItemRenderer>
                </MudDropContainer>
            }
        </div>
    </div>
}